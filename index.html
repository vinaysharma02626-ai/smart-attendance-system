<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Attendance System Pro - College Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --secondary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --light: #f3f4f6;
            --dark: #1f2937;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
        }

        .header-info {
            text-align: right;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
            padding: 0;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 0.95em;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: white;
            color: var(--primary);
        }

        .nav-tab.active {
            background: white;
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #6ee7b7;
            display: flex;
        }

        .message.error {
            background: #fee2e2;
            color: #7f1d1d;
            border: 2px solid #fca5a5;
            display: flex;
        }

        .message.info {
            background: #cffafe;
            color: #164e63;
            border: 2px solid #06b6d4;
            display: flex;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .stat-card.success { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); }
        .stat-card.danger { background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); }
        .stat-card.warning { background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%); }
        .stat-card.info { background: linear-gradient(135deg, var(--info) 0%, #0284c7 100%); }

        .form-section {
            background: var(--light);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid var(--primary);
        }

        .form-section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1e3a8a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 64, 175, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.85em;
        }

        .search-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-section input {
            flex: 1;
            min-width: 200px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        table tbody tr:hover {
            background: var(--light);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
            display: inline-block;
        }

        .status-present { background: #d1fae5; color: #065f46; }
        .status-absent { background: #fee2e2; color: #7f1d1d; }
        .status-late { background: #fef3c7; color: #92400e; }
        .status-leave { background: #e9d5ff; color: #6b21a8; }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        canvas {
            max-height: 300px;
        }

        .alert-box {
            background: #fef3c7;
            border: 2px solid var(--warning);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #92400e;
        }

        .alert-box strong {
            color: #d97706;
        }

        .export-btn {
            background: var(--success);
            color: white;
            padding: 12px 25px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .filter-section {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-size: 1.1em;
        }

        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .attendance-box {
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .attendance-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .attendance-box.selected {
            border-color: var(--primary);
            background: rgba(30, 64, 175, 0.1);
        }

        .attendance-box label {
            cursor: pointer;
            margin: 0;
        }

        .insights-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .insights-box h3 {
            margin-bottom: 15px;
        }

        .insights-box p {
            margin: 10px 0;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 10px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-group {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                overflow-x: auto;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 0.85em;
            }

            table {
                font-size: 0.85em;
            }

            table th, table td {
                padding: 8px;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üìä Smart Attendance System Pro</h1>
                <p>Advanced Attendance Management for Colleges</p>
            </div>
            <div class="header-info">
                <div>Department: CSE</div>
                <div id="currentDate"></div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">üìà Dashboard</button>
            <button class="nav-tab" onclick="switchTab('attendance')">‚úì Mark Attendance</button>
            <button class="nav-tab" onclick="switchTab('analytics')">üìä Analytics</button>
            <button class="nav-tab" onclick="switchTab('reports')">üìÑ Reports</button>
            <button class="nav-tab" onclick="switchTab('directory')">üë• Students</button>
            <button class="nav-tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <div class="content">
            <div id="message" class="message"></div>

            <!-- DASHBOARD TAB -->
            <div id="dashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <h3 id="totalStudents">0</h3>
                        <p>Total Students</p>
                    </div>
                    <div class="stat-card success">
                        <h3 id="presentToday">0</h3>
                        <p>Present Today</p>
                    </div>
                    <div class="stat-card danger">
                        <h3 id="absentToday">0</h3>
                        <p>Absent Today</p>
                    </div>
                    <div class="stat-card warning">
                        <h3 id="avgAttendance">0%</h3>
                        <p>Avg Attendance</p>
                    </div>
                </div>

                <div id="lowAttendanceAlert"></div>

                <div class="chart-container">
                    <h3>üìà This Week's Attendance Trend</h3>
                    <canvas id="weekChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üìä Subject-wise Attendance</h3>
                    <canvas id="subjectChart"></canvas>
                </div>

                <div class="insights-box">
                    <h3>üí° Insights & Recommendations</h3>
                    <div id="insightsContent"></div>
                </div>
            </div>

            <!-- MARK ATTENDANCE TAB -->
            <div id="attendance" class="tab-content">
                <div class="form-section">
                    <h2>‚ûï Mark Attendance</h2>

                    <div class="form-group">
                        <div>
                            <label for="attDate">Date *</label>
                            <input type="date" id="attDate">
                        </div>
                        <div>
                            <label for="attSubject">Subject *</label>
                            <select id="attSubject"></select>
                        </div>
                        <div>
                            <label for="attSection">Section *</label>
                            <select id="attSection"></select>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <label>Student Attendance Status:</label>
                        <div class="attendance-grid" id="attendanceGrid"></div>
                    </div>

                    <div class="button-group">
                        <button class="btn-success" onclick="submitAttendance()">‚úì Submit Attendance</button>
                        <button class="btn-secondary" onclick="clearAttendanceForm()">Clear</button>
                    </div>
                </div>

                <div id="bulkActions" style="margin-top: 20px;">
                    <div class="form-section">
                        <h2>‚ö° Quick Actions</h2>
                        <div class="button-group">
                            <button class="btn-primary btn-small" onclick="markAllPresent()">Mark All Present</button>
                            <button class="btn-danger btn-small" onclick="markAllAbsent()">Mark All Absent</button>
                            <button class="btn-warning btn-small" onclick="clearAllSelection()">Clear Selection</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS TAB -->
            <div id="analytics" class="tab-content">
                <div class="filter-section">
                    <div>
                        <label for="analyticsSubject">Subject:</label>
                        <select id="analyticsSubject"></select>
                    </div>
                    <div>
                        <label for="analyticsSection">Section:</label>
                        <select id="analyticsSection"></select>
                    </div>
                    <div>
                        <label for="analyticsStudent">Student:</label>
                        <input type="text" id="analyticsStudent" placeholder="Name or Roll No">
                    </div>
                    <button class="btn-primary" onclick="applyAnalyticsFilter()">Apply Filter</button>
                </div>

                <div class="chart-container">
                    <h3>üìÖ Month-wise Attendance</h3>
                    <canvas id="monthChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üìä Week-wise Analysis</h3>
                    <canvas id="weekAnalyticsChart"></canvas>
                </div>

                <h2 style="margin-top: 30px; color: var(--primary);">Attendance Summary by Subject</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Total Classes</th>
                            <th>Present</th>
                            <th>Absent</th>
                            <th>Attendance %</th>
                        </tr>
                    </thead>
                    <tbody id="subjectSummaryTable">
                    </tbody>
                </table>
            </div>

            <!-- REPORTS TAB -->
            <div id="reports" class="tab-content">
                <div class="form-section">
                    <h2>üìÑ Generate Reports</h2>

                    <div class="form-group">
                        <div>
                            <label for="reportType">Report Type *</label>
                            <select id="reportType">
                                <option value="">Select Report Type</option>
                                <option value="student">Individual Student Report</option>
                                <option value="class">Class Report</option>
                                <option value="subject">Subject Report</option>
                                <option value="critical">Low Attendance Alert</option>
                            </select>
                        </div>
                        <div>
                            <label for="reportDate">Month *</label>
                            <input type="month" id="reportDate">
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="export-btn" onclick="generateReport()">Generate Report</button>
                        <button class="export-btn" onclick="exportToCSV()">üì• Export to CSV</button>
                    </div>
                </div>

                <div id="reportContent"></div>
            </div>

            <!-- DIRECTORY TAB -->
            <div id="directory" class="tab-content">
                <div class="search-section">
                    <input type="text" id="studentSearch" placeholder="Search by name or roll number...">
                    <button class="btn-primary" onclick="searchStudents()">Search</button>
                    <button class="btn-secondary" onclick="clearStudentSearch()">Reset</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Section</th>
                            <th>Batch</th>
                            <th>Avg Attendance</th>
                        </tr>
                    </thead>
                    <tbody id="studentTable">
                    </tbody>
                </table>
            </div>

            <!-- SETTINGS TAB -->
            <div id="settings" class="tab-content">
                <div class="form-section">
                    <h2>‚öôÔ∏è System Settings</h2>

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">‚úì Active Subjects</h3>
                        <div id="subjectsList"></div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">‚úì Active Sections</h3>
                        <div id="sectionsList"></div>
                    </div>

                    <div class="button-group">
                        <button class="btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
                        <button class="btn-secondary" onclick="resetToDefaults()">‚Ü∫ Reset to Defaults</button>
                    </div>
                </div>

                <div class="form-section" style="margin-top: 20px;">
                    <h2>‚ÑπÔ∏è System Information</h2>
                    <p><strong>Version:</strong> 2.0 Pro Edition</p>
                    <p><strong>Department:</strong> Computer Science & Engineering</p>
                    <p><strong>Institution:</strong> College of Engineering</p>
                    <p><strong>Last Updated:</strong> <span id="lastUpdate"></span></p>
                    <p><strong>Data Records:</strong> <span id="totalRecords">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== DATA STRUCTURE =====
        const subjects = [
            { id: 1, code: 'DS', name: 'Data Structures' },
            { id: 2, code: 'DBMS', name: 'Database Management Systems' },
            { id: 3, code: 'OS', name: 'Operating Systems' },
            { id: 4, code: 'CN', name: 'Computer Networks' },
            { id: 5, code: 'WD', name: 'Web Development' },
            { id: 6, code: 'SE', name: 'Software Engineering' },
            { id: 7, code: 'CD', name: 'Compiler Design' },
            { id: 8, code: 'AI', name: 'Artificial Intelligence' },
            { id: 9, code: 'DM', name: 'Discrete Mathematics' },
            { id: 10, code: 'DE', name: 'Digital Electronics' }
        ];

        const students = [
            { id: 1, name: 'Amit Kumar', rollNo: 'CSE001', email: 'amit@college.ac.in', section: 'A', batch: 2022 },
            { id: 2, name: 'Dinesh Patel', rollNo: 'CSE002', email: 'dinesh@college.ac.in', section: 'A', batch: 2022 },
            { id: 3, name: 'Rahul Singh', rollNo: 'CSE003', email: 'rahul@college.ac.in', section: 'A', batch: 2022 },
            { id: 4, name: 'Priya Sharma', rollNo: 'CSE004', email: 'priya@college.ac.in', section: 'B', batch: 2022 },
            { id: 5, name: 'Arjun Reddy', rollNo: 'CSE005', email: 'arjun@college.ac.in', section: 'B', batch: 2022 },
            { id: 6, name: 'Neha Gupta', rollNo: 'CSE006', email: 'neha@college.ac.in', section: 'B', batch: 2022 },
            { id: 7, name: 'Vivek Joshi', rollNo: 'CSE007', email: 'vivek@college.ac.in', section: 'C', batch: 2022 },
            { id: 8, name: 'Anjali Verma', rollNo: 'CSE008', email: 'anjali@college.ac.in', section: 'C', batch: 2022 },
            { id: 9, name: 'Karan Malhotra', rollNo: 'CSE009', email: 'karan@college.ac.in', section: 'A', batch: 2022 },
            { id: 10, name: 'Zara Khan', rollNo: 'CSE010', email: 'zara@college.ac.in', section: 'B', batch: 2022 },
            { id: 11, name: 'Vikram Patel', rollNo: 'CSE011', email: 'vikram@college.ac.in', section: 'C', batch: 2022 },
            { id: 12, name: 'Sneha Das', rollNo: 'CSE012', email: 'sneha@college.ac.in', section: 'A', batch: 2022 },
            { id: 13, name: 'Roshan Singh', rollNo: 'CSE013', email: 'roshan@college.ac.in', section: 'B', batch: 2022 },
            { id: 14, name: 'Pooja Sharma', rollNo: 'CSE014', email: 'pooja@college.ac.in', section: 'C', batch: 2022 },
            { id: 15, name: 'Aditya Nair', rollNo: 'CSE015', email: 'aditya@college.ac.in', section: 'A', batch: 2022 }
        ];

        const sections = ['A', 'B', 'C'];

        let attendanceRecords = [];
        let selectedAttendance = {};

        // ===== INITIALIZATION =====
        window.onload = function() {
            generateSampleData();
            initializeUI();
            loadDashboard();
            setCurrentDate();
        };

        function initializeUI() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attDate').value = today;
            document.getElementById('reportDate').value = new Date().toISOString().slice(0, 7);

            // Populate subject selects
            const subjectSelects = document.querySelectorAll('[id$="Subject"]');
            subjectSelects.forEach(select => {
                select.innerHTML = '<option value="">Select Subject</option>' + 
                    subjects.map(s => `<option value="${s.id}">${s.code} - ${s.name}</option>`).join('');
            });

            // Populate section selects
            const sectionSelects = document.querySelectorAll('[id$="Section"]');
            sectionSelects.forEach(select => {
                select.innerHTML = sections.map(s => `<option value="${s}">${s}</option>`).join('');
            });

            // Populate student directory
            loadStudentDirectory();

            // Populate settings
            loadSettings();
        }

        function generateSampleData() {
            const today = new Date();
            for (let i = 30; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                subjects.forEach(subject => {
                    sections.forEach(section => {
                        const sectionStudents = students.filter(s => s.section === section);
                        sectionStudents.forEach(student => {
                            const statuses = ['Present', 'Absent', 'Late', 'Leave'];
                            const status = statuses[Math.floor(Math.random() * statuses.length)];
                            attendanceRecords.push({
                                studentId: student.id,
                                subject: subject.id,
                                date: dateStr,
                                section: section,
                                status: status,
                                time: status === 'Present' ? '08:30' : (status === 'Late' ? '09:15' : '-')
                            });
                        });
                    });
                });
            }
        }

        function setCurrentDate() {
            const today = new Date();
            document.getElementById('currentDate').textContent = today.toLocaleDateString('en-IN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('lastUpdate').textContent = today.toLocaleString('en-IN');
        }

        // ===== TAB SWITCHING =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') loadDashboard();
            else if (tabName === 'analytics') loadAnalytics();
            else if (tabName === 'reports') loadReports();
            else if (tabName === 'attendance') loadAttendanceForm();
        }

        // ===== DASHBOARD =====
        function loadDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = attendanceRecords.filter(r => r.date === today);

            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('presentToday').textContent = todayRecords.filter(r => r.status === 'Present').length;
            document.getElementById('absentToday').textContent = todayRecords.filter(r => r.status === 'Absent').length;

            const avgAtt = calculateAverageAttendance();
            document.getElementById('avgAttendance').textContent = avgAtt.toFixed(1) + '%';

            // Low attendance alert
            const lowAttendanceStudents = getLowAttendanceStudents();
            if (lowAttendanceStudents.length > 0) {
                const alertHTML = '<div class="alert-box"><strong>‚ö†Ô∏è Low Attendance Alert:</strong><br>' + 
                    lowAttendanceStudents.map(s => `${s.name} (${s.percentage.toFixed(1)}%)`).join(', ') + 
                    '</div>';
                document.getElementById('lowAttendanceAlert').innerHTML = alertHTML;
            }

            drawWeekChart();
            drawSubjectChart();
            loadInsights();
            document.getElementById('totalRecords').textContent = attendanceRecords.length;
        }

        function calculateAverageAttendance() {
            if (attendanceRecords.length === 0) return 0;
            const presentCount = attendanceRecords.filter(r => r.status === 'Present').length;
            return (presentCount / attendanceRecords.length) * 100;
        }

        function getLowAttendanceStudents(threshold = 75) {
            const result = [];
            students.forEach(student => {
                const studentRecords = attendanceRecords.filter(r => r.studentId === student.id);
                if (studentRecords.length > 0) {
                    const present = studentRecords.filter(r => r.status === 'Present').length;
                    const percentage = (present / studentRecords.length) * 100;
                    if (percentage < threshold) {
                        result.push({ name: student.name, percentage });
                    }
                }
            });
            return result;
        }

        function drawWeekChart() {
            const canvas = document.getElementById('weekChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            const today = new Date();
            const weekData = [];
            const labels = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                labels.push(date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));

                const dayRecords = attendanceRecords.filter(r => r.date === dateStr);
                const presentCount = dayRecords.filter(r => r.status === 'Present').length;
                weekData.push(dayRecords.length > 0 ? (presentCount / dayRecords.length) * 100 : 0);
            }

            drawLineChart(ctx, labels, weekData, 'Weekly Attendance Trend');
        }

        function drawSubjectChart() {
            const canvas = document.getElementById('subjectChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            const labels = subjects.map(s => s.code);
            const data = subjects.map(s => {
                const subjectRecords = attendanceRecords.filter(r => r.subject === s.id && r.status === 'Present');
                const total = attendanceRecords.filter(r => r.subject === s.id).length;
                return total > 0 ? (subjectRecords.length / total) * 100 : 0;
            });

            drawBarChart(ctx, labels, data, 'Attendance by Subject');
        }

        function loadInsights() {
            const insights = [
                '‚úì Overall attendance is ' + calculateAverageAttendance().toFixed(1) + '%',
                '‚úì Total attendance records: ' + attendanceRecords.length,
                '‚úì Low attendance students: ' + getLowAttendanceStudents().length,
                '‚úì Recommended: Focus on improving attendance in the coming weeks'
            ];
            document.getElementById('insightsContent').innerHTML = insights.map(i => `<p>${i}</p>`).join('');
        }

        // ===== ATTENDANCE MARKING =====
        function loadAttendanceForm() {
            const subject = document.getElementById('attSubject').value;
            const section = document.getElementById('attSection').value || 'A';

            const sectionStudents = students.filter(s => s.section === section);
            let html = '';

            sectionStudents.forEach(student => {
                const key = `${student.id}_${subject}`;
                const checked = selectedAttendance[key] || '';
                html += `
                    <div class="attendance-box ${checked ? 'selected' : ''}" id="box_${key}">
                        <input type="checkbox" id="att_${key}" 
                               onchange="toggleAttendance('${key}', this.checked)"
                               style="width: 100%; margin-bottom: 5px;">
                        <label for="att_${key}" style="margin: 0; font-size: 0.85em;">
                            <strong>${student.rollNo}</strong><br>
                            ${student.name}
                        </label>
                    </div>
                `;
            });

            document.getElementById('attendanceGrid').innerHTML = html;
        }

        function toggleAttendance(key, checked) {
            if (checked) {
                selectedAttendance[key] = true;
                document.getElementById('box_' + key).classList.add('selected');
            } else {
                delete selectedAttendance[key];
                document.getElementById('box_' + key).classList.remove('selected');
            }
        }

        function submitAttendance() {
            const date = document.getElementById('attDate').value;
            const subject = document.getElementById('attSubject').value;
            const section = document.getElementById('attSection').value;

            if (!date || !subject || !section) {
                showMessage('Please select Date, Subject, and Section', 'error');
                return;
            }

            const sectionStudents = students.filter(s => s.section === section);

            sectionStudents.forEach(student => {
                const key = `${student.id}_${subject}`;
                const existingRecord = attendanceRecords.find(r => 
                    r.studentId === student.id && r.subject === parseInt(subject) && r.date === date && r.section === section
                );

                if (existingRecord) {
                    existingRecord.status = selectedAttendance[key] ? 'Present' : 'Absent';
                } else {
                    attendanceRecords.push({
                        studentId: student.id,
                        subject: parseInt(subject),
                        date: date,
                        section: section,
                        status: selectedAttendance[key] ? 'Present' : 'Absent',
                        time: selectedAttendance[key] ? '08:30' : '-'
                    });
                }
            });

            showMessage('‚úÖ Attendance submitted successfully!', 'success');
            clearAttendanceForm();
        }

        function markAllPresent() {
            const subject = document.getElementById('attSubject').value;
            const section = document.getElementById('attSection').value || 'A';
            const sectionStudents = students.filter(s => s.section === section);

            sectionStudents.forEach(student => {
                const key = `${student.id}_${subject}`;
                selectedAttendance[key] = true;
                document.getElementById('box_' + key).classList.add('selected');
                document.getElementById('att_' + key).checked = true;
            });

            showMessage('‚úÖ All marked as Present', 'info');
        }

        function markAllAbsent() {
            const subject = document.getElementById('attSubject').value;
            const section = document.getElementById('attSection').value || 'A';
            const sectionStudents = students.filter(s => s.section === section);

            sectionStudents.forEach(student => {
                const key = `${student.id}_${subject}`;
                delete selectedAttendance[key];
                document.getElementById('box_' + key).classList.remove('selected');
                document.getElementById('att_' + key).checked = false;
            });

            showMessage('‚úÖ All marked as Absent', 'info');
        }

        function clearAllSelection() {
            selectedAttendance = {};
            document.querySelectorAll('.attendance-box').forEach(box => box.classList.remove('selected'));
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function clearAttendanceForm() {
            clearAllSelection();
            document.getElementById('attSubject').value = '';
            document.getElementById('attSection').value = 'A';
        }

        // ===== ANALYTICS =====
        function loadAnalytics() {
            drawMonthChart();
            drawWeekAnalyticsChart();
            loadSubjectSummary();
        }

        function drawMonthChart() {
            const canvas = document.getElementById('monthChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            const today = new Date();
            const monthData = [];
            const labels = [];

            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                if (i % 3 === 0) labels.push(date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
                else labels.push('');

                const dateStr = date.toISOString().split('T')[0];
                const dayRecords = attendanceRecords.filter(r => r.date === dateStr);
                const presentCount = dayRecords.filter(r => r.status === 'Present').length;
                monthData.push(dayRecords.length > 0 ? (presentCount / dayRecords.length) * 100 : 0);
            }

            drawLineChart(ctx, labels, monthData, 'Monthly Attendance Trend');
        }

        function drawWeekAnalyticsChart() {
            const canvas = document.getElementById('weekAnalyticsChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            const today = new Date();
            const weekData = [];
            const labels = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dayName = date.toLocaleDateString('en-IN', { weekday: 'short' });
                labels.push(dayName);

                const dateStr = date.toISOString().split('T')[0];
                const dayRecords = attendanceRecords.filter(r => r.date === dateStr);
                const present = dayRecords.filter(r => r.status === 'Present').length;
                const absent = dayRecords.filter(r => r.status === 'Absent').length;
                weekData.push({ present, absent, total: dayRecords.length });
            }

            drawStackedChart(ctx, labels, weekData);
        }

        function loadSubjectSummary() {
            let html = '';
            subjects.forEach(subject => {
                const records = attendanceRecords.filter(r => r.subject === subject.id);
                const present = records.filter(r => r.status === 'Present').length;
                const absent = records.filter(r => r.status === 'Absent').length;
                const percentage = records.length > 0 ? (present / records.length) * 100 : 0;

                html += `<tr>
                    <td>${subject.code} - ${subject.name}</td>
                    <td>${records.length}</td>
                    <td><span class="status-badge status-present">${present}</span></td>
                    <td><span class="status-badge status-absent">${absent}</span></td>
                    <td><strong>${percentage.toFixed(1)}%</strong></td>
                </tr>`;
            });
            document.getElementById('subjectSummaryTable').innerHTML = html;
        }

        function applyAnalyticsFilter() {
            loadAnalytics();
            showMessage('‚úÖ Filters applied', 'success');
        }

        // ===== STUDENT DIRECTORY =====
        function loadStudentDirectory() {
            let html = '';
            students.forEach(student => {
                const studentRecords = attendanceRecords.filter(r => r.studentId === student.id);
                const present = studentRecords.filter(r => r.status === 'Present').length;
                const avgAtt = studentRecords.length > 0 ? ((present / studentRecords.length) * 100).toFixed(1) : 0;

                html += `<tr>
                    <td>${student.rollNo}</td>
                    <td>${student.name}</td>
                    <td>${student.email}</td>
                    <td>${student.section}</td>
                    <td>${student.batch}</td>
                    <td><strong>${avgAtt}%</strong></td>
                </tr>`;
            });
            document.getElementById('studentTable').innerHTML = html;
        }

        function searchStudents() {
            const search = document.getElementById('studentSearch').value.toLowerCase();
            let html = '';
            students.filter(s => s.name.toLowerCase().includes(search) || s.rollNo.includes(search))
                .forEach(student => {
                    const studentRecords = attendanceRecords.filter(r => r.studentId === student.id);
                    const present = studentRecords.filter(r => r.status === 'Present').length;
                    const avgAtt = studentRecords.length > 0 ? ((present / studentRecords.length) * 100).toFixed(1) : 0;
                    html += `<tr>
                        <td>${student.rollNo}</td>
                        <td>${student.name}</td>
                        <td>${student.email}</td>
                        <td>${student.section}</td>
                        <td>${student.batch}</td>
                        <td><strong>${avgAtt}%</strong></td>
                    </tr>`;
                });
            document.getElementById('studentTable').innerHTML = html;
        }

        function clearStudentSearch() {
            document.getElementById('studentSearch').value = '';
            loadStudentDirectory();
        }

        // ===== REPORTS =====
        function loadReports() {
            document.getElementById('reportContent').innerHTML = '';
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            if (!reportType) {
                showMessage('Please select a report type', 'error');
                return;
            }
            showMessage('‚úÖ Report generated successfully!', 'success');
        }

        function exportToCSV() {
            let csv = 'Roll No,Name,Email,Section,Batch,Average Attendance
';
            students.forEach(student => {
                const studentRecords = attendanceRecords.filter(r => r.studentId === student.id);
                const present = studentRecords.filter(r => r.status === 'Present').length;
                const avgAtt = studentRecords.length > 0 ? (present / studentRecords.length) * 100 : 0;
                csv += `${student.rollNo},${student.name},${student.email},${student.section},${student.batch},${avgAtt.toFixed(1)}
`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'attendance_report.csv';
            a.click();
            showMessage('‚úÖ CSV exported successfully!', 'success');
        }

        // ===== SETTINGS =====
        function loadSettings() {
            let subjectsHtml = subjects.map(s => `<p>‚úì ${s.code} - ${s.name}</p>`).join('');
            document.getElementById('subjectsList').innerHTML = subjectsHtml;

            let sectionsHtml = sections.map(s => `<p>‚úì Section ${s}</p>`).join('');
            document.getElementById('sectionsList').innerHTML = sectionsHtml;
        }

        function saveSettings() {
            showMessage('‚úÖ Settings saved successfully!', 'success');
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to default?')) {
                showMessage('‚úÖ Settings reset to defaults', 'success');
            }
        }

        // ===== UTILITIES =====
        function showMessage(msg, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = msg;
            msgDiv.className = 'message ' + type;
            setTimeout(() => { msgDiv.className = 'message'; }, 3000);
        }

        function drawLineChart(ctx, labels, data, title) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = 'bold 14px Arial';
            ctx.fillText(title, 20, 25);

            const padding = 40;
            const width = ctx.canvas.width - 2 * padding;
            const height = ctx.canvas.height - 60;
            const step = width / (labels.length - 1);

            ctx.strokeStyle = '#1e40af';
            ctx.lineWidth = 3;
            ctx.beginPath();

            data.forEach((val, i) => {
                const x = padding + i * step;
                const y = ctx.canvas.height - padding - (val / 100) * height;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            ctx.strokeStyle = '#ccc';
            ctx.font = '12px Arial';
            ctx.fillStyle = '#666';
            labels.forEach((label, i) => {
                const x = padding + i * step;
                ctx.fillText(label, x - 20, ctx.canvas.height - padding + 20);
            });
        }

        function drawBarChart(ctx, labels, data, title) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = 'bold 14px Arial';
            ctx.fillText(title, 20, 25);

            const barWidth = Math.min(30, ctx.canvas.width / (labels.length * 1.5));
            const padding = 40;

            labels.forEach((label, i) => {
                const x = padding + i * (barWidth + 20);
                const barHeight = (data[i] / 100) * (ctx.canvas.height - 80);
                ctx.fillStyle = '#10b981';
                ctx.fillRect(x, ctx.canvas.height - padding - barHeight, barWidth, barHeight);
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.fillText(label, x - 10, ctx.canvas.height - padding + 20);
                ctx.fillText(data[i].toFixed(1) + '%', x - 15, ctx.canvas.height - padding - barHeight - 10);
            });
        }

        function drawStackedChart(ctx, labels, data) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Daily Attendance Overview', 20, 25);

            const barWidth = 40;
            const padding = 40;

            labels.forEach((label, i) => {
                const x = padding + i * (barWidth + 20);
                const total = data[i].total || 1;
                const presentHeight = (data[i].present / total) * (ctx.canvas.height - 80);
                const absentHeight = (data[i].absent / total) * (ctx.canvas.height - 80);

                ctx.fillStyle = '#10b981';
                ctx.fillRect(x, ctx.canvas.height - padding - presentHeight, barWidth, presentHeight);
                ctx.fillStyle = '#ef4444';
                ctx.fillRect(x, ctx.canvas.height - padding - presentHeight - absentHeight, barWidth, absentHeight);

                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.fillText(label, x - 10, ctx.canvas.height - padding + 20);
            });
        }
    </script>
</body>
</html>